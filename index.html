<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chat Privado</title>

<style>
*{box-sizing:border-box;}

body{
  margin:0;
  font-family:'Segoe UI', sans-serif;
  background:#ece5dd;
  height:100vh;
  display:flex;
  justify-content:center;
}

.container{
  width:100%;
  max-width:420px;
  height:100vh;
  background:white;
  display:flex;
  flex-direction:column;
}

/* HEADER */

.header{
  background:#075E54;
  color:white;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:bold;
  position:fixed;
  top:0;
  width:100%;
  max-width:420px;
  z-index:10;
  height:55px;
}

.logout{
  background:#128C7E;
  border:none;
  color:white;
  padding:6px 10px;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
}

/* LOGIN */

.login{
  margin:auto;
  width:85%;
  max-width:300px;
  text-align:center;
}

.login h2{
  color:#075E54;
}

.login input{
  width:100%;
  padding:12px;
  margin:10px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}

.login button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:#25D366;
  color:white;
  font-size:16px;
  cursor:pointer;
}

/* CHAT */

.chat{
  display:none;
  flex-direction:column;
  height:100%;
  padding-top:55px;
  padding-bottom:70px;
  box-sizing:border-box;
}

.messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  background:#ece5dd;
}

/* MENSAJES */

.message{
  max-width:75%;
  padding:10px;
  margin:5px 0;
  border-radius:12px;
  font-size:14px;
  word-wrap:break-word;
  word-break:break-word;
  white-space:normal;
  overflow-wrap:break-word;
}

.sent{
  align-self:flex-end;
  background:#DCF8C6;
}

.received{
  align-self:flex-start;
  background:white;
  border:1px solid #ddd;
}

.username{
  font-weight:bold;
  font-size:11px;
  opacity:0.6;
  margin-bottom:3px;
}

.message-text{
  word-wrap:break-word;
  word-break:break-word;
  white-space:pre-wrap;
  overflow-wrap:break-word;
}

.message img{
  max-width:100%;
  border-radius:8px;
  margin-top:5px;
  cursor:pointer;
  display:block;
}

.photo-blur {
  filter:blur(8px);
  cursor:pointer;
}

.photo-status{
  font-size:12px;
  opacity:0.8;
  margin-top:5px;
  font-weight:500;
}

/* MODAL PARA VER FOTO COMPLETA */

.modal{
  display:none;
  position:fixed;
  z-index:20;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.8);
  justify-content:center;
  align-items:center;
}

.modal.active{
  display:flex;
}

.modal-content{
  max-width:90%;
  max-height:90%;
  position:relative;
}

.modal-content img{
  max-width:100%;
  max-height:100%;
  border-radius:8px;
}

.modal-close{
  position:absolute;
  top:10px;
  right:10px;
  background:white;
  border:none;
  border-radius:50%;
  width:30px;
  height:30px;
  font-size:20px;
  cursor:pointer;
  z-index:21;
}

/* FOOTER */

.footer{
  position:fixed;
  bottom:0;
  width:100%;
  max-width:420px;
  display:flex;
  padding:8px;
  border-top:1px solid #ddd;
  background:white;
  align-items:center;
  gap:5px;
  height:70px;
  box-sizing:border-box;
  z-index:15;
}

.footer input[type="text"]{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
  font-size:16px;
}

.footer button{
  border:none;
  border-radius:50%;
  width:40px;
  height:40px;
  font-size:18px;
  background:#25D366;
  color:white;
  cursor:pointer;
  flex-shrink:0;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
  <span>Chat Privado</span>
  <button class="logout" onclick="logout()">Salir</button>
</div>

<div class="login" id="loginSection">
  <h2>Iniciar SesiÃ³n</h2>
  <input type="text" id="username" placeholder="Usuario">
  <input type="password" id="password" placeholder="ContraseÃ±a">
  <button onclick="login()">Entrar</button>
</div>

<div class="chat" id="chatSection">
  <div class="messages" id="messages"></div>
</div>

<div class="footer" id="chatFooter" style="display:none;">
  <input type="file" id="imageInput" accept="image/*" hidden>
  <button onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
  <input type="text" id="messageInput" placeholder="Mensaje">
  <button onclick="sendMessage()">âž¤</button>
</div>

<!-- MODAL PARA VER FOTO COMPLETA -->
<div class="modal" id="photoModal">
  <div class="modal-content" id="modalContent">
    <button class="modal-close" onclick="closePhotoModal()">âœ•</button>
    <img id="modalImage" src="">
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, addDoc, onSnapshot, orderBy, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyB8MX9UKhyhatywGhPbpIldBD80wsY38BI",
  authDomain: "chat01234.firebaseapp.com",
  projectId: "chat01234",
  storageBucket: "chat01234.firebasestorage.app",
  messagingSenderId: "861947372030",
  appId: "1:861947372030:web:3f1d0c4709b3d96fe6a0af"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;

/* LOGIN */
window.login = async function(){
  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();
  if(!user || !pass) return alert("Completa los campos");

  const q = query(collection(db,"users"),
    where("username","==",user),
    where("password","==",pass));

  const snap = await getDocs(q);

  if(snap.empty){
    alert("Datos incorrectos");
  }else{
    currentUser = user;
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("chatSection").style.display = "flex";
    document.getElementById("chatFooter").style.display = "flex";
    loadMessages();
  }
}

/* LOGOUT */
window.logout = function(){
  location.reload();
}

/* ENVIAR TEXTO */
window.sendMessage = async function(){
  const text = document.getElementById("messageInput").value.trim();
  if(text === "") return;

  await addDoc(collection(db,"messages"),{
    text: text,
    username: currentUser,
    createdAt: new Date(),
    type: "text"
  });

  document.getElementById("messageInput").value = "";
}

/* ENVIAR IMAGEN */
document.getElementById("imageInput").addEventListener("change", async(e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const storageRef = ref(storage, "chatImages/" + Date.now() + "_" + file.name);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);

  await addDoc(collection(db,"messages"),{
    imageUrl: url,
    username: currentUser,
    createdAt: new Date(),
    viewedBy: [],
    type: "image"
  });

  document.getElementById("imageInput").value = "";
});

/* ABRIR MODAL CON FOTO */
window.openPhotoModal = async function(docId, imageUrl, username){
  // Solo marcar como vista si el receptor (no el remitente) abre la foto
  if(username !== currentUser){
    try {
      const messageDoc = doc(db, "messages", docId);
      await updateDoc(messageDoc, {
        viewedBy: [currentUser]
      });
    } catch(error) {
      console.log("Error al actualizar:", error);
    }
  }
  
  document.getElementById("modalImage").src = imageUrl;
  document.getElementById("photoModal").classList.add("active");
}

/* CERRAR MODAL */
window.closePhotoModal = function(){
  document.getElementById("photoModal").classList.remove("active");
}

/* CARGAR MENSAJES */
function loadMessages(){
  const q = query(collection(db,"messages"), orderBy("createdAt"));

  onSnapshot(q, (snapshot)=>{
    const messagesDiv = document.getElementById("messages");
    
    messagesDiv.innerHTML = "";

    snapshot.forEach(doc=>{
      const data = doc.data();
      const docId = doc.id;
      
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(data.username === currentUser ? "sent" : "received");

      let content = `<div class="username">${data.username}</div>`;

      if(data.text){
        content += `<div class="message-text">${escapeHtml(data.text)}</div>`;
      }

      if(data.imageUrl){
        const viewedBy = data.viewedBy || [];
        const wasViewed = viewedBy.length > 0;
        const isSender = data.username === currentUser;
        const otherUser = currentUser === "pipe" ? "angie" : "pipe";

        if(isSender){
          // YO ENVIÃ‰ LA FOTO
          // Angie siempre ve texto
          content += `<div class="photo-status">ðŸ“¸ Disponible 1 sola vez para ${otherUser}</div>`;
        } else {
          // LA OTRA PERSONA ENVIÃ“ LA FOTO
          if(wasViewed){
            // YO YA LA VI
            content += `<div class="photo-status">ðŸ“¸ Foto vista</div>`;
          } else {
            // YO AÃšN NO LA VEO - Pixeleada
            content += `<img src="${data.imageUrl}" class="photo-blur" onclick="openPhotoModal('${docId}', '${data.imageUrl}', '${data.username}')" alt="Foto">`;
          }
        }
      }

      div.innerHTML = content;
      messagesDiv.appendChild(div);
    });

    // Scroll al final
    setTimeout(() => {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, 10);
  });
}

/* ESCAPE HTML PARA SEGURIDAD */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>

</body>
</html>

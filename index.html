<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Privado</title>

<style>
*{box-sizing:border-box;}

body{
  margin:0;
  font-family:'Segoe UI', sans-serif;
  background:#ece5dd;
  height:100vh;
}

.container{
  width:100%;
  max-width:420px;
  height:100vh;
  margin:auto;
  background:white;
  display:flex;
  flex-direction:column;
  box-shadow:0 0 20px rgba(0,0,0,0.2);
}

/* HEADER */

.header{
  background:#075E54;
  color:white;
  padding:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:bold;
}

.logout{
  background:#128C7E;
  border:none;
  color:white;
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
}

/* LOGIN */

.login{
  margin:auto;
  width:85%;
  max-width:320px;
  text-align:center;
}

.login h2{
  color:#075E54;
  margin-bottom:25px;
}

input{
  width:100%;
  padding:12px;
  margin:10px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:#25D366;
  color:white;
  font-size:15px;
  cursor:pointer;
  transition:0.2s;
}

button:hover{
  opacity:0.9;
}

/* CHAT */

.chat{
  display:none;
  flex-direction:column;
  height:100%;
}

.messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  background:#ece5dd;
}

/* MENSAJES */

.message{
  max-width:75%;
  padding:10px;
  margin:5px 0;
  border-radius:12px;
  font-size:14px;
  word-wrap:break-word;
}

.sent{
  align-self:flex-end;
  background:#DCF8C6;
}

.received{
  align-self:flex-start;
  background:white;
  border:1px solid #ddd;
}

.username{
  font-weight:bold;
  font-size:11px;
  margin-bottom:3px;
  opacity:0.6;
}

/* FOOTER FIJO */

.footer{
  display:flex;
  padding:10px;
  border-top:1px solid #ddd;
  background:white;
}

.footer input{
  flex:1;
  margin:0;
}

.footer button{
  width:80px;
  margin-left:5px;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
  <span>Chat Privado</span>
  <button class="logout" onclick="logout()">Salir</button>
</div>

<div class="login" id="loginSection">
  <h2>Bienvenido</h2>
  <input type="text" id="username" placeholder="Usuario">
  <input type="password" id="password" placeholder="Contraseña">
  <button onclick="login()">Entrar</button>
</div>

<div class="chat" id="chatSection">
  <div class="messages" id="messages"></div>
  <div class="footer">
    <input type="text" id="messageInput" placeholder="Escribe mensaje">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, addDoc, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB8MX9UKhyhatywGhPbpIldBD80wsY38BI",
  authDomain: "chat01234.firebaseapp.com",
  projectId: "chat01234",
  storageBucket: "chat01234.firebasestorage.app",
  messagingSenderId: "861947372030",
  appId: "1:861947372030:web:3f1d0c4709b3d96fe6a0af"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null;

/* -------- RESTAURAR SESIÓN -------- */
window.addEventListener("load",()=>{
  const savedUser = localStorage.getItem("chatUser");
  if(savedUser){
    currentUser = savedUser;
    showChat();
    loadMessages();
  }
});

/* -------- LOGIN -------- */
window.login = async function(){
  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();

  if(!user || !pass) return alert("Completa los campos");

  const q = query(
    collection(db,"users"),
    where("username","==",user),
    where("password","==",pass)
  );

  const snapshot = await getDocs(q);

  if(snapshot.empty){
    alert("Usuario o contraseña incorrectos");
  } else {
    currentUser = user;
    localStorage.setItem("chatUser", user);
    showChat();
    loadMessages();
  }
}

/* -------- LOGOUT -------- */
window.logout = function(){
  localStorage.removeItem("chatUser");
  currentUser = null;
  document.getElementById("chatSection").style.display="none";
  document.getElementById("loginSection").style.display="block";
}

/* -------- MOSTRAR CHAT -------- */
function showChat(){
  document.getElementById("loginSection").style.display="none";
  document.getElementById("chatSection").style.display="flex";
}

/* -------- ENVIAR MENSAJE -------- */
window.sendMessage = async function(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(text==="") return;

  await addDoc(collection(db,"messages"),{
    text:text,
    username:currentUser,
    createdAt:new Date()
  });

  input.value="";
}

/* ENTER ENVÍA */
document.addEventListener("keypress",function(e){
  if(e.key==="Enter" && currentUser){
    sendMessage();
  }
});

/* -------- CARGAR MENSAJES -------- */
function loadMessages(){
  const q = query(collection(db,"messages"),orderBy("createdAt"));

  onSnapshot(q,(snapshot)=>{
    const messagesDiv=document.getElementById("messages");
    messagesDiv.innerHTML="";

    snapshot.forEach(doc=>{
      const data = doc.data();
      const div=document.createElement("div");
      div.classList.add("message");

      if(data.username === currentUser){
        div.classList.add("sent");
      } else {
        div.classList.add("received");
      }

      div.innerHTML = `
        <div class="username">${data.username}</div>
        <div>${data.text}</div>
      `;

      messagesDiv.appendChild(div);
    });

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}
</script>

</body>
</html>
